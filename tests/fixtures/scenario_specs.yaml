# Especificaciones de los 62 escenarios de auditoría.
# Usado por el generador de CSVs y los tests parametrizados.

metadata:
  version: "2.0"
  total_scenarios: 62
  last_updated: "2025-01-07"
  fixes_applied:
    - "FIX-001: Renovación dual de mains"
    - "FIX-002: Cancelación de hedges pendientes"
    - "FIX-003: FIFO atómico Main+Hedge"

core:
  c01_tp_simple_buy:
    priority: critical
    description: "BUY toca TP +10 pips"
    pair: EURUSD
    initial_balance: 10000.0
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020, event: "Start"}
      - {time: 1, bid: 1.10020, ask: 1.10040, event: "BUY activates"}
      - {time: 2, bid: 1.10050, ask: 1.10070, event: "Moving towards TP"}
      - {time: 3, bid: 1.10120, ask: 1.10140, event: "TP hit"}
    checks:
      - "buy_op.status == OperationStatus.TP_HIT"
      - "buy_op.profit_pips == 10.0"
    expected_output: {balance: 10002.0}

  c01_tp_simple_sell:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.09980, ask: 1.10000, event: "SELL activates"}
      - {time: 3, bid: 1.09880, ask: 1.09900, event: "TP hit"}
    checks: ["sell_op.status == OperationStatus.TP_HIT"]

  c03_activation_no_tp:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10020, ask: 1.10040}
      - {time: 3, bid: 1.10080, ask: 1.10100}
    checks: ["buy_op.status == OperationStatus.ACTIVE"]

  c04_no_activation:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.09995, ask: 1.10015}
    checks: ["buy_op.status == OperationStatus.PENDING"]

  c05_gap_tp:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10020, ask: 1.10040}
      - {time: 2, bid: 1.10200, ask: 1.10220, event: "Gap"}
    checks: ["buy_op.status == OperationStatus.TP_HIT"]

cycles:
  cy01_new_cycle:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["cycle.status == CycleStatus.PENDING"]

  cy02_tp_in_cycle:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10120, ask: 1.10140}
    checks: ["cycle.accounting.total_main_tps == 1"]

  cy03_tp_renews_operations:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10120, ask: 1.10140}
    checks: ["len(cycle.operations) >= 4"]

  cy04_cancel_counter_main:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10120, ask: 1.10140}
    checks: ["sell_op.status == OperationStatus.CANCELLED"]

  cy05_complete_10_tps:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 10, bid: 1.11000, ask: 1.11020} # Simulado
    checks: ["cycle.accounting.total_main_tps == 10"]

  cy06_multiple_cycles:
    priority: high
    pair: MULTI
    pairs: [EURUSD, GBPUSD]
    sequence:
      - {time: 0, pair: EURUSD, bid: 1.10000, ask: 1.10020}
      - {time: 1, pair: GBPUSD, bid: 1.25000, ask: 1.25020}
    checks: ["len(active_cycles) == 2"]

hedged:
  h01_both_active_hedged:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10020, ask: 1.10040}
      - {time: 2, bid: 1.09980, ask: 1.10000}
    checks: ["cycle.status == CycleStatus.HEDGED"]

  h02_create_hedge_operations:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10050, ask: 1.10070}
    checks: ["len(cycle.operations) >= 4"]

  h03_neutralize_mains:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10020, ask: 1.10040}
    checks: ["main_buy.status == OperationStatus.NEUTRALIZED"]

  h04_lock_20_pips:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["cycle.accounting.pips_locked == 20.0"]

  h05_sequential_activation:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 10, bid: 1.09980, ask: 1.10000}
    checks: ["cycle.status == CycleStatus.HEDGED"]

  h06_simultaneous_gap:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10050, ask: 1.10070} # Gap activa ambas
    checks: ["cycle.status == CycleStatus.HEDGED"]

  h07_buy_tp_hedge_sell:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10120, ask: 1.10140}
    checks: ["hedge_sell.status == OperationStatus.CANCELLED"]

  h08_sell_tp_hedge_buy:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.09880, ask: 1.09900}
    checks: ["hedge_buy.status == OperationStatus.CANCELLED"]

recovery:
  r01_open_from_tp:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10120, ask: 1.10140}
    checks: ["recovery_buy.metadata['reference_price'] == 1.10120"]

  r02_recovery_distance_20:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10120, ask: 1.10140}]
    checks: ["abs(recovery_buy.entry_price - 1.10120) == 0.00020"]

  r03_recovery_n1_tp_buy:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10140, ask: 1.10160}
      - {time: 1, bid: 1.10220, ask: 1.10240}
    checks: ["recovery.status == OperationStatus.TP_HIT"]

  r04_recovery_n1_tp_sell:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10100, ask: 1.10120}
      - {time: 1, bid: 1.10020, ask: 1.10040}
    checks: ["recovery.status == OperationStatus.TP_HIT"]

  r05_recovery_n1_fails_n2:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10140, ask: 1.10160}
      - {time: 2, bid: 1.10180, ask: 1.10200}
    checks: ["len(parent_cycle.accounting.recovery_queue) == 2"]

  r06_recovery_n2_success:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10180, ask: 1.10200}
      - {time: 1, bid: 1.10260, ask: 1.10280}
    checks: ["parent_cycle.accounting.pips_recovered == 60.0"]

  r07_cascade_n1_n2_n3:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10140, ask: 1.10160}
      - {time: 1, bid: 1.10180, ask: 1.10200}
      - {time: 2, bid: 1.10220, ask: 1.10240}
    checks: ["parent_cycle.recovery_level == 3"]

  r08_recovery_max_n6:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10140, ask: 1.10160}]
    checks: ["parent_cycle.recovery_level == 6"]

  r09_cancel_recovery_counter:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10140, ask: 1.10160}
      - {time: 1, bid: 1.10220, ask: 1.10240}
    checks: ["recovery_sell.status == OperationStatus.CANCELLED"]

  r10_multiple_recovery_pairs:
    priority: medium
    pair: MULTI
    pairs: [EURUSD, GBPUSD]
    sequence:
      - {time: 0, pair: EURUSD, bid: 1.10140, ask: 1.10160}
      - {time: 0, pair: GBPUSD, bid: 1.25140, ask: 1.25160}
    checks: ["len(active_cycles) == 2"]

fifo:
  f01_fifo_first_costs_20:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10140, ask: 1.10160}
      - {time: 1, bid: 1.10220, ask: 1.10240}
    checks: ["parent_cycle.accounting.get_recovery_cost() == 20.0"]

  f02_fifo_subsequent_40:
    priority: critical
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10180, ask: 1.10200}
      - {time: 1, bid: 1.10260, ask: 1.10280}
    checks: ["parent_cycle.accounting.get_recovery_cost() == 40.0"]

  f03_fifo_atomic_close:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10140, ask: 1.10160}]
    checks: ["main.closed_at == hedge.closed_at"]

  f04_fifo_multiple_close:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10180, ask: 1.10200}]
    checks: ["len(closed_debt_units) == 2"]

risk_management:
  rm01_exposure_limit:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["exposure_pct < 30.0"]

  rm02_drawdown_limit:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["system.status == 'PAUSED'"]

  rm03_daily_loss_limit:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["system.status == 'PAUSED'"]

  rm04_margin_insufficient:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["result.success == False"]

  rm05_recovery_exposure:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["total_exposure includes recovery operations"]

money_management:
  mm01_balance_read:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["account.balance == 10000.0"]

  mm02_pnl_tp:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["operation.profit_pips == 10.0"]

  mm03_pnl_hedged:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["cycle.accounting.pips_locked == 20.0"]

  mm04_balance_update_tp:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["account.balance >= 10000.0"]

  mm05_equity_calculation:
    priority: critical
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["account.equity == account.balance + floating_pnl"]

  mm06_margin_calculation:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["margin_required > 0"]

  mm07_free_margin:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["account.margin_free > 0"]

  mm08_recovery_pnl_accumulation:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10140, ask: 1.10160}]
    checks: ["total_pips_recovered > 0"]

edge_cases:
  e01_spread_rejection:
    priority: medium
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10035}]
    checks: ["signal.signal_type == SignalType.NO_ACTION"]

  e02_high_spread_rejection:
    priority: high
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10050}]
    checks: ["strategy.can_trade() == False"]

  e03_weekend_gap:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10200, ask: 1.10220}
    checks: ["cycle.metadata['gap_detected'] == True"]

  e04_mega_move:
    priority: high
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.12500, ask: 1.12520}
    checks: ["price_move > 200"]

  e05_return_to_origin:
    priority: medium
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 2, bid: 1.10000, ask: 1.10020}
    checks: ["current_price == initial_price"]

  e06_lateral_market:
    priority: medium
    pair: EURUSD
    sequence:
      - {time: 0, bid: 1.10000, ask: 1.10020}
      - {time: 1, bid: 1.10100, ask: 1.10120}
    checks: ["cycle.accounting.total_tps >= 1"]

  e07_connection_lost:
    priority: medium
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["broker.is_connected() == True"]

  e08_rollover_swap:
    priority: low
    pair: EURUSD
    sequence: [{time: 0, bid: 1.10000, ask: 1.10020}]
    checks: ["True"]

multi_pair:
  mp01_dual_pair:
    priority: high
    pair: MULTI
    pairs: [EURUSD, GBPUSD]
    sequence:
      - {time: 0, pair: EURUSD, bid: 1.10000, ask: 1.10020}
      - {time: 0, pair: GBPUSD, bid: 1.25000, ask: 1.25020}
    checks: ["len(active_cycles) == 2"]

  mp02_correlation_hedged:
    priority: high
    pair: MULTI
    pairs: [EURUSD, GBPUSD]
    sequence:
      - {time: 0, pair: EURUSD, bid: 1.10000, ask: 1.10020}
      - {time: 0, pair: GBPUSD, bid: 1.25000, ask: 1.25020}
    checks: ["eurusd_cycle.status == CycleStatus.HEDGED"]

  mp03_jpy_calculation:
    priority: high
    pair: USDJPY
    sequence: [{time: 0, bid: 110.00, ask: 110.05}]
    checks: ["pip_multiplier == 100"]

  mp04_total_exposure:
    priority: high
    pair: MULTI
    pairs: [EURUSD, GBPUSD]
    sequence:
      - {time: 0, pair: EURUSD, bid: 1.10000, ask: 1.10020}
      - {time: 0, pair: GBPUSD, bid: 1.25000, ask: 1.25020}
    checks: ["total_lots > 0"]

jpy_pairs:
  j01_usdjpy_tp:
    priority: high
    pair: USDJPY
    sequence:
      - {time: 0, bid: 110.00, ask: 110.05}
      - {time: 1, bid: 110.15, ask: 110.20}
    checks: ["operation.profit_pips == 10.0"]

  j02_usdjpy_hedged:
    priority: high
    pair: USDJPY
    sequence:
      - {time: 0, bid: 110.00, ask: 110.05}
      - {time: 1, bid: 109.95, ask: 110.00}
    checks: ["cycle.status == CycleStatus.HEDGED"]

  j03_usdjpy_recovery:
    priority: high
    pair: USDJPY
    sequence:
      - {time: 0, bid: 110.25, ask: 110.30}
      - {time: 1, bid: 111.05, ask: 111.10}
    checks: ["recovery.status == OperationStatus.TP_HIT"]

  j04_usdjpy_pips_calculation:
    priority: high
    pair: USDJPY
    sequence:
      - {time: 0, bid: 110.00, ask: 110.05}
      - {time: 1, bid: 110.15, ask: 110.20}
    checks: ["profit_pips == 10.0"]
